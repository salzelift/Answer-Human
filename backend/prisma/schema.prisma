
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}


enum Role {
  ADMIN
  KNOWLEDGE_SEEKER
  KNOWLEDGE_PROVIDER
}

enum AvailableDays {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum PaymentMethod {
  RAZORPAY
  STRIPE
  QR_CODE
}

enum CommunicationMedium {
  VIDEO_CALL
  AUDIO_CALL
  MESSAGE
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  role      Role
  isEmailVerified Boolean @default(false)
  knowledgeProvider KnowledgeProvider?
  knowledgeSeeker KnowledgeSeeker?
  otps      OTP[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OTP {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  code      String
  type      OTPType
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, type])
}

enum OTPType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum QuestionStatus {
  PENDING
  ANSWERED
  CLOSED
}

model Questions {
  id        String   @id @default(uuid())
  knowledgeSeeker KnowledgeSeeker @relation(fields: [knowledgeSeekerId], references: [id])
  knowledgeSeekerId String
  knowledgeProvider KnowledgeProvider? @relation(fields: [knowledgeProviderId], references: [id])
  knowledgeProviderId String?
  questionTitle String
  questionDescription String
  questionCategory String
  questionTags String[]
  questionStatus QuestionStatus @default(PENDING)
  appointments Appointment[]
  proposals Proposal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KnowledgeProvider {
  id        String   @id @default(uuid())
  user User @relation(fields: [userId], references: [id])
  userId String @unique

  //provider profile details 

  name String
  description String?
  websiteUrl String?
  linkedinUrl String?
  twitterUrl String?
  githubUrl String?
  facebookUrl String?
  instagramUrl String?
  youtubeUrl String?
  tiktokUrl String?
  profilePictureUrl String?
  bannerPictureUrl String?
  location String?
  categories Category[]
  company String?
  jobTitle String?
  education String?
  skills String[]
  interests String[]
  bio String?

  // provider verification & availability details
  isVerified Boolean @default(false)
  verifiedAt DateTime?
  isAvailable Boolean @default(true)
  availableDays String[]
  availableTimes String[]
  availableLanguages String[]

  // provider booking details
  appointments Appointment[]
  questions Questions[]
  proposals Proposal[]
  
  // wallet relation
  wallet ExpertWallet?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KnowledgeSeeker {
  id        String   @id @default(uuid())
  user User @relation(fields: [userId], references: [id])
  userId String @unique

  // Basic Information
  name String
  email String
  phone String
  interestedCategories Category[]
  profilePictureUrl String?
  isOnboarded Boolean @default(false)

  // Demographic Heuristics
  age Int?
  gender String?
  occupation String?
  educationLevel String?
  experienceLevel String? // Beginner, Intermediate, Advanced, Expert

  // Preference Heuristics
  preferredCommunicationMedium String? // VIDEO_CALL, AUDIO_CALL, MESSAGE
  preferredPriceRange String? // 0-50, 50-100, 100-200, 200+
  preferredSessionDuration String? // 30min, 1hr, 2hr, 3hr+
  preferredTimeSlots String[] // Morning, Afternoon, Evening, Night
  preferredLanguages String[]
  budgetRange String? // Monthly budget: 0-100, 100-500, 500-1000, 1000+
  urgencyLevel String? // Low, Medium, High, Critical

  // Learning & Interaction Preferences
  learningStyle String? // Visual, Auditory, Reading, Kinesthetic, Mixed
  preferredExpertRating Decimal? // Minimum rating 1.0-5.0
  preferredResponseTime String? // Immediate, Within 1hr, Within 24hr, Flexible
  preferredExpertLocation String? // Same timezone, Same country, Any
  timezone String?

  // Technical Preferences
  devicePreferences String[] // Desktop, Mobile, Tablet
  notificationPreferences Json? // Email, SMS, Push settings

  // Behavioral Heuristics for Recommendations
  searchHistory Json? // Array of search queries with timestamps
  clickPatterns Json? // Track which experts/categories are clicked most
  lastActiveAt DateTime?
  profileCompletionScore Int @default(0) // 0-100 percentage

  // Relations
  searches Questions[]
  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Appointment {
  id        String   @id @default(uuid())
  knowledgeProvider KnowledgeProvider @relation(fields: [knowledgeProviderId], references: [id])
  knowledgeProviderId String
  knowledgeSeeker KnowledgeSeeker @relation(fields: [knowledgeSeekerId], references: [id])
  knowledgeSeekerId String
  appointmentDate DateTime
  appointmentTime DateTime
  appointmentStatus AppointmentStatus @default(PENDING)
  communicationMedium CommunicationMedium
  totalPaymemnt Decimal
  paymentStatus PaymentStatus @default(PENDING)
  questions Questions @relation(fields: [questionsId], references: [id])
  questionsId String
  paymentMethod PaymentMethod
  paymentTransactionId String?
  paymentTransactionStatus String?
  paymentTransactionError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Category {
  id String @id @default(uuid())
  name String
  description String
  imageUrl String
  slug String
  parentCategoryId String?
  parentCategory Category? @relation("SelfRelation", fields: [parentCategoryId], references: [id])
  subCategories Category[] @relation("SelfRelation")

  knowledgeProviders KnowledgeProvider[]
  knowledgeSeekers KnowledgeSeeker[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Proposal Model

model Proposal {
  id                  String   @id @default(uuid())
  questionId          String
  question            Questions @relation(fields: [questionId], references: [id])
  expertId            String
  expert              KnowledgeProvider @relation(fields: [expertId], references: [id])
  message             String
  price               Decimal
  communicationMedium String
  estimatedDuration   String
  status              ProposalStatus @default(PENDING)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([questionId])
  @@index([expertId])
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// Payment & Wallet Models

enum TransactionType {
  CREDIT
  PAYOUT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

model ExpertWallet {
  id           String   @id @default(uuid())
  expertId     String   @unique
  expert       KnowledgeProvider @relation(fields: [expertId], references: [id])
  balance      Decimal  @default(0)
  currency     String   @default("INR")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  transactions WalletTransaction[]
  bankDetails  ExpertBankDetails?
}

model ExpertBankDetails {
  id                String   @id @default(uuid())
  walletId          String   @unique
  wallet            ExpertWallet @relation(fields: [walletId], references: [id])
  accountHolderName String
  accountNumber     String
  ifscCode          String
  bankName          String
  currency          String   @default("INR")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model WalletTransaction {
  id                String   @id @default(uuid())
  walletId          String
  wallet            ExpertWallet @relation(fields: [walletId], references: [id])
  type              TransactionType
  amount            Decimal
  currency          String
  status            TransactionStatus
  razorpayPaymentId String?
  razorpayPayoutId  String?
  appointmentId     String?
  description       String?
  createdAt         DateTime @default(now())
}